#!/usr/bin/env python

import os,time,datetime
import requests
import urllib, json
from tabulate import tabulate
import sys
import pdb

#tas = [[datetime.date(2017, 4, 21), '386.38000', '12.94100', '5000.00000'], [datetime.date(2017, 5, 8), '395.93000', '3.78900', '1500.00000'], [datetime.date(2017, 5, 11), '402.81000', '2.48300', '1000.00000'], [datetime.date(2017, 5, 15), '402.98000', '3.72200', '1500.00000'], [datetime.date(2017, 5, 18), '396.28000', '2.52300', '1000.00000'], [datetime.date(2017, 5, 22), '388.21000', '3.86400', '1500.00000'], [datetime.date(2017, 5, 25), '393.38000', '2.54200', '1000.00000'], [datetime.date(2017, 5, 29), '397.25000', '3.77600', '1500.00000'], [datetime.date(2017, 6, 1), '403.34000', '3.71900', '1500.00000'], [datetime.date(2017, 6, 1), '403.34000', '2.47900', '1000.00000'], [datetime.date(2017, 6, 7), '407.78000', '3.67800', '1500.00000'], [datetime.date(2017, 6, 14), '409.49000', '3.66300', '1500.00000'], [datetime.date(2017, 6, 16), '409.42000', '2.44200', '1000.00000'], [datetime.date(2017, 6, 21), '409.94000', '3.65900', '1500.00000'], [datetime.date(2017, 6, 23), '402.81000', '2.48300', '1000.00000'], [datetime.date(2017, 6, 28), '399.93000', '3.75100', '1500.00000'], [datetime.date(2017, 6, 30), '403.61000', '2.47800', '1000.00000'], [datetime.date(2017, 7, 3), '407.12000', '3.68400', '1500.00000'], [datetime.date(2017, 7, 7), '408.40000', '3.67300', '1500.00000'], [datetime.date(2017, 7, 7), '408.40000', '2.44900', '1000.00000'], [datetime.date(2017, 7, 14), '417.59000', '3.59200', '1500.00000'], [datetime.date(2017, 7, 14), '417.59000', '2.39500', '1000.00000'], [datetime.date(2017, 7, 21), '421.07000', '3.56200', '1500.00000'], [datetime.date(2017, 7, 21), '421.07000', '2.37500', '1000.00000'], [datetime.date(2017, 7, 28), '429.54000', '3.49200', '1500.00000'], [datetime.date(2017, 7, 28), '429.54000', '2.32800', '1000.00000'], [datetime.date(2017, 8, 1), '435.10000', '3.44700', '1500.00000'], [datetime.date(2017, 8, 4), '438.31000', '2.28100', '1000.00000'], [datetime.date(2017, 8, 7), '441.73000', '3.39600', '1500.00000'], [datetime.date(2017, 8, 11), '418.08000', '2.39200', '1000.00000'], [datetime.date(2017, 8, 14), '428.74000', '3.49900', '1500.00000'], [datetime.date(2017, 8, 18), '431.78000', '2.31600', '1000.00000'], [datetime.date(2017, 8, 21), '427.41000', '3.51000', '1500.00000'], [datetime.date(2017, 8, 28), '436.04000', '3.44000', '1500.00000'], [datetime.date(2017, 8, 28), '436.04000', '2.29300', '1000.00000'], [datetime.date(2017, 9, 1), '442.17000', '3.39200', '1500.00000'], [datetime.date(2017, 9, 1), '442.17000', '2.26200', '1000.00000'], [datetime.date(2017, 9, 7), '447.73000', '3.35000', '1500.00000'], [datetime.date(2017, 9, 8), '447.26000', '2.23600', '1000.00000'], [datetime.date(2017, 9, 14), '453.18000', '3.31000', '1500.00000'], [datetime.date(2017, 9, 15), '453.60000', '2.20500', '1000.00000'], [datetime.date(2017, 9, 21), '453.73000', '3.30600', '1500.00000'], [datetime.date(2017, 9, 22), '442.44000', '2.26000', '1000.00000'], [datetime.date(2017, 9, 28), '432.23000', '3.47000', '1500.00000'], [datetime.date(2017, 9, 29), '435.67000', '2.29500', '1000.00000'], [datetime.date(2017, 10, 3), '439.20000', '3.41500', '1500.00000'], [datetime.date(2017, 10, 6), '447.85000', '2.23300', '1000.00000'], [datetime.date(2017, 10, 9), '447.43000', '3.35200', '1500.00000'], [datetime.date(2017, 10, 13), '452.79000', '2.20900', '1000.00000'], [datetime.date(2017, 10, 16), '454.03000', '3.30400', '1500.00000'], [datetime.date(2017, 10, 23), '453.33000', '3.30900', '1500.00000'], [datetime.date(2017, 10, 23), '453.33000', '2.20600', '1000.00000'], [datetime.date(2017, 10, 27), '452.39000', '2.21000', '1000.00000'], [datetime.date(2017, 10, 30), '456.29000', '3.28700', '1500.00000'], [datetime.date(2017, 11, 1), '457.43000', '3.27900', '1500.00000'], [datetime.date(2017, 11, 3), '457.80000', '2.18400', '1000.00000'], [datetime.date(2017, 11, 7), '451.54000', '3.32200', '1500.00000'], [datetime.date(2017, 11, 10), '450.04000', '2.22200', '1000.00000'], [datetime.date(2017, 11, 14), '446.70000', '3.35800', '1500.00000'], [datetime.date(2017, 11, 17), '451.57000', '2.21400', '1000.00000'], [datetime.date(2017, 11, 21), '453.47000', '3.30800', '1500.00000'], [datetime.date(2017, 11, 24), '455.70000', '2.19400', '1000.00000'], [datetime.date(2017, 11, 28), '456.63000', '3.28500', '1500.00000'], [datetime.date(2017, 12, 1), '447.56000', '2.23400', '1000.00000'], [datetime.date(2017, 12, 4), '446.62000', '3.35900', '1500.00000'], [datetime.date(2017, 12, 7), '450.25000', '3.33100', '1500.00000'], [datetime.date(2017, 12, 8), '453.99000', '2.20300', '1000.00000'], [datetime.date(2017, 12, 14), '452.22000', '3.31700', '1500.00000'], [datetime.date(2017, 12, 15), '457.04000', '2.18800', '1000.00000'], [datetime.date(2017, 12, 21), '466.32000', '3.21700', '1500.00000'], [datetime.date(2017, 12, 22), '467.78000', '2.13800', '1000.00000'], [datetime.date(2017, 12, 28), '466.13000', '3.21800', '1500.00000'], [datetime.date(2017, 12, 29), '468.19000', '2.13600', '1000.00000'], [datetime.date(2018, 1, 1), '465.57000', '3.22200', '1500.00000'], [datetime.date(2018, 1, 5), '468.98000', '2.13200', '1000.00000'], [datetime.date(2018, 1, 8), '470.61000', '3.18700', '1500.00000'], [datetime.date(2018, 1, 12), '467.91000', '2.13700', '1000.00000'], [datetime.date(2018, 1, 15), '466.79000', '3.21300', '1500.00000'], [datetime.date(2018, 1, 19), '463.17000', '2.15900', '1000.00000'], [datetime.date(2018, 1, 22), '463.21000', '3.23800', '1500.00000'], [datetime.date(2018, 1, 29), '461.70000', '3.24900', '1500.00000'], [datetime.date(2018, 1, 29), '461.70000', '2.16600', '1000.00000'], [datetime.date(2018, 2, 1), '455.30000', '3.29500', '1500.00000'], [datetime.date(2018, 2, 2), '440.39000', '2.27100', '1000.00000'], [datetime.date(2018, 2, 7), '431.49000', '3.47600', '1500.00000'], [datetime.date(2018, 2, 9), '432.51000', '2.31200', '1000.00000'], [datetime.date(2018, 2, 14), '435.35000', '3.44600', '1500.00000'], [datetime.date(2018, 2, 16), '430.12000', '2.32500', '1000.00000'], [datetime.date(2018, 2, 21), '427.38000', '3.51000', '1500.00000'], [datetime.date(2018, 2, 23), '431.71000', '2.31600', '1000.00000'], [datetime.date(2018, 2, 28), '434.95000', '3.44900', '1500.00000'], [datetime.date(2018, 3, 1), '433.17000', '3.46300', '1500.00000'], [datetime.date(2018, 3, 5), '429.81000', '2.32700', '1000.00000'], [datetime.date(2018, 3, 7), '421.15000', '3.56200', '1500.00000'], [datetime.date(2018, 3, 9), '422.08000', '2.36900', '1000.00000'], [datetime.date(2018, 3, 14), '430.60000', '0.19300', '83.00000'], [datetime.date(2018, 3, 16), '424.42000', '2.35600', '1000.00000'], [datetime.date(2018, 3, 23), '414.71000', '2.41100', '1000.00000'], [datetime.date(2018, 4, 2), '427.21000', '2.34100', '1000.00000'], [datetime.date(2018, 4, 6), '435.43000', '2.29700', '1000.00000'], [datetime.date(2018, 4, 13), '439.08000', '2.27700', '1000.00000'], [datetime.date(2018, 4, 20), '441.14000', '2.26700', '1000.00000'], [datetime.date(2018, 4, 27), '446.90000', '2.23800', '1000.00000'], [datetime.date(2018, 5, 4), '438.08000', '2.28300', '1000.00000'], [datetime.date(2018, 5, 11), '442.12000', '2.26200', '1000.00000'], [datetime.date(2018, 5, 18), '434.66000', '2.30100', '1000.00000'], [datetime.date(2018, 5, 25), '431.98000', '2.31500', '1000.00000'], [datetime.date(2018, 6, 1), '431.90000', '2.31500', '1000.00000'], [datetime.date(2018, 6, 8), '432.69000', '2.31100', '1000.00000'], [datetime.date(2018, 6, 15), '434.73000', '2.30000', '1000.00000'], [datetime.date(2018, 6, 22), '428.90000', '2.33200', '1000.00000'], [datetime.date(2018, 6, 29), '425.27000', '2.35100', '1000.00000'], [datetime.date(2018, 7, 6), '428.84000', '2.33200', '1000.00000'], [datetime.date(2018, 7, 13), '438.69000', '2.28000', '1000.00000'], [datetime.date(2018, 7, 20), '440.79000', '2.26900', '1000.00000'], [datetime.date(2018, 7, 27), '451.92000', '2.21300', '1000.00000'], [datetime.date(2018, 8, 3), '451.12000', '2.21700', '1000.00000'], [datetime.date(2018, 8, 9), '456.93000', '2.18900', '1000.00000'], [datetime.date(2018, 8, 16), '455.31000', '2.19600', '1000.00000'], [datetime.date(2018, 8, 23), '463.37000', '2.15800', '1000.00000'], [datetime.date(2018, 8, 30), '463.60000', '2.15700', '1000.00000'], [datetime.date(2018, 9, 6), '449.78000', '2.22300', '1000.00000'], [datetime.date(2018, 9, 14), '448.23000', '2.23100', '1000.00000'], [datetime.date(2018, 9, 21), '426.06000', '2.34700', '1000.00000'], [datetime.date(2018, 9, 27), '415.66000', '2.40600', '1000.00000'], [datetime.date(2018, 10, 4), '398.16000', '2.51200', '1000.00000'], [datetime.date(2018, 10, 11), '384.23000', '2.60300', '1000.00000'], [datetime.date(2018, 10, 19), '383.95000', '2.60500', '1000.00000'], [datetime.date(2018, 10, 25), '375.33000', '2.66400', '1000.00000'], [datetime.date(2018, 11, 1), '393.85000', '2.53900', '1000.00000'], [datetime.date(2018, 11, 9), '400.62000', '2.49600', '1000.00000'], [datetime.date(2018, 11, 15), '402.59000', '2.48400', '1000.00000'], [datetime.date(2018, 11, 22), '396.81000', '2.52000', '1000.00000'], [datetime.date(2018, 11, 29), '405.71000', '2.46500', '1000.00000'], [datetime.date(2018, 12, 6), '395.91000', '2.52600', '1000.00000'], [datetime.date(2018, 12, 13), '406.21000', '2.46200', '1000.00000'], [datetime.date(2018, 12, 20), '411.90000', '2.42800', '1000.00000'], [datetime.date(2018, 12, 27), '403.95000', '2.47600', '1000.00000'], [datetime.date(2019, 1, 3), '402.83000', '2.48200', '1000.00000'], [datetime.date(2019, 1, 10), '405.43000', '2.46700', '1000.00000'], [datetime.date(2019, 1, 17), '404.07000', '2.47500', '1000.00000'], [datetime.date(2019, 1, 24), '400.68000', '2.49600', '1000.00000'], [datetime.date(2019, 1, 31), '396.44000', '2.52200', '1000.00000'], [datetime.date(2019, 2, 7), '403.80000', '2.47600', '1000.00000'], [datetime.date(2019, 2, 14), '389.22000', '2.56900', '1000.00000'], [datetime.date(2019, 2, 21), '392.67000', '2.54700', '1000.00000'], [datetime.date(2019, 2, 28), '395.27000', '2.53000', '1000.00000'], [datetime.date(2019, 3, 7), '407.48000', '2.45400', '1000.00000'], [datetime.date(2019, 3, 14), '416.47000', '2.40100', '1000.00000'], [datetime.date(2019, 3, 22), '416.84000', '2.39900', '1000.00000'], [datetime.date(2019, 3, 28), '423.50000', '2.36100', '1000.00000'], [datetime.date(2019, 4, 4), '423.80000', '2.36000', '1000.00000'], [datetime.date(2019, 4, 11), '421.56000', '2.37200', '1000.00000'], [datetime.date(2019, 4, 18), '426.14000', '2.34700', '1000.00000'], [datetime.date(2019, 4, 25), '423.98000', '2.35900', '1000.00000'], [datetime.date(2019, 5, 2), '424.92000', '2.35300', '1000.00000'], [datetime.date(2019, 5, 9), '411.13000', '2.43200', '1000.00000'], [datetime.date(2019, 5, 16), '409.21000', '2.44400', '1000.00000'], [datetime.date(2019, 5, 23), '425.40000', '2.35100', '1000.00000'], [datetime.date(2019, 5, 30), '439.12000', '2.27700', '1000.00000'], [datetime.date(2019, 6, 6), '434.67000', '2.30100', '1000.00000'], [datetime.date(2019, 6, 13), '435.87000', '2.29400', '1000.00000'], [datetime.date(2019, 6, 20), '430.57000', '2.32300', '1000.00000'], [datetime.date(2019, 6, 27), '435.46000', '2.29600', '1000.00000'], [datetime.date(2019, 7, 4), '434.73000', '2.30000', '1000.00000'], [datetime.date(2019, 7, 11), '421.10000', '2.37500', '1000.00000'], [datetime.date(2019, 7, 18), '418.44000', '2.39000', '1000.00000'], [datetime.date(2019, 7, 25), '401.06000', '2.49300', '1000.00000'], [datetime.date(2020, 2, 24), '468.63000', '-405.00000', '-189793.00000']]
tas = [[datetime.date(2020, 4, 1), '2185.21870', '-1.14400', '-2500.00000'], [datetime.date(2020, 3, 31), '2175.71700', '-1.14900', '-2500.00000'], [datetime.date(2019, 12, 10), '2166.03800', '-1.15400', '-2500.00000'], [datetime.date(2019, 11, 11), '2156.86570', '-1.15900', '-2500.00000'], [datetime.date(2019, 10, 10), '2146.71840', '-1.16500', '-2500.00000'], [datetime.date(2019, 9, 11), '2136.98070', '-1.17000', '-2500.00000'], [datetime.date(2019, 8, 13), '2127.26550', '-1.17500', '-2500.00000'], [datetime.date(2019, 7, 10), '2114.28860', '-1.18200', '-2500.00000'], [datetime.date(2019, 6, 10), '2102.60710', '-1.18900', '-2500.00000'], [datetime.date(2019, 5, 10), '2089.67550', '-1.19600', '-2500.00000'], [datetime.date(2019, 4, 10), '2077.67170', '-1.20300', '-2500.00000'], [datetime.date(2019, 3, 11), '2064.01740', '-1.21100', '-2500.00000'], [datetime.date(2019, 2, 11), '2053.03210', '-1.21800', '-2500.00000'], [datetime.date(2019, 1, 10), '2040.28450', '-1.22500', '-2500.00000'], [datetime.date(2018, 12, 10), '2027.56330', '-1.23300', '-2500.00000'], [datetime.date(2018, 11, 12), '2015.66200', '-1.24000', '-2500.00000'], [datetime.date(2018, 10, 10), '2002.08810', '-1.24900', '-2500.00000'], [datetime.date(2018, 9, 10), '1990.09000', '-1.25600', '-2500.00000'], [datetime.date(2018, 8, 10), '1978.18000', '-1.26400', '-2500.00000'], [datetime.date(2018, 7, 10), '1966.03310', '-1.27200', '-2500.00000'], [datetime.date(2018, 6, 11), '1954.10390', '-1.27900', '-2500.00000'], [datetime.date(2018, 5, 10), '1942.03360', '-1.28700', '-2500.00000'], [datetime.date(2018, 4, 10), '1931.35260', '-1.29400', '-2500.00000'], [datetime.date(2018, 3, 12), '1918.77390', '-1.30300', '-2500.00000'], [datetime.date(2018, 2, 12), '1908.63520', '-1.31000', '-2500.00000'], [datetime.date(2018, 1, 10), '1897.28740', '-1.31800', '-2500.00000'], [datetime.date(2017, 12, 11), '1887.09480', '-1.32500', '-2500.00000'], [datetime.date(2017, 11, 10), '1876.93540', '-1.33200', '-2500.00000'], [datetime.date(2017, 10, 10), '1866.74740', '-1.33900', '-2500.00000'], [datetime.date(2017, 9, 11), '1857.10730', '-1.34600', '-2500.00000'], [datetime.date(2017, 8, 10), '1846.75780', '-1.35400', '-2500.00000'], [datetime.date(2017, 7, 10), '1836.48370', '-1.36100', '-2500.00000'], [datetime.date(2017, 6, 12), '1827.06930', '-1.36800', '-2500.00000'], [datetime.date(2017, 5, 11), '1816.57000', '-1.37600', '-2500.00000'], [datetime.date(2017, 4, 10), '1806.57070', '-1.38400', '-2500.00000'], [datetime.date(2017, 3, 20), '1799.06020', '55.58500', '100000.00000']]

#tas = [[datetime.date(2020, 2, 10), '1400', '-1', '-1400.00000'], [datetime.date(2020, 1, 10), '1200', '-3', '-3600.00000'], [datetime.date(2019, 12, 10), '1150', '-1', '-1150.00000'], [datetime.date(2019, 11, 11), '1100', '-2', '-2200.00000'], [datetime.date(2019, 10, 10), '1000', '9', '9000.00000'], [datetime.date(2019, 9, 10), '900', '1', '900.00000']]

def leap_year(year):
	if (year % 4) == 0:
		if (year % 100) == 0:
			if (year % 400) == 0:
				return 91
			else:
				return 90
		else:
			return 91
	else:
		return 90

def gain_summary(gain_list):
	gain_sum = {}
	for i in gain_list:
		#print(i[0], (i[0] - datetime.timedelta(days = leap_year(i[0].year))).year)
		year =  (i[0] - datetime.timedelta(days = leap_year(i[0].year))).year
		if year not in gain_sum.keys():
			gain_sum[year] = 0
		gain_sum[year] = gain_sum[year] + float(i[1])

	return gain_sum



def capital_gain(t_list):
	gain_list = []
	try:
		sindex = next(t_list.index(x) for x in t_list if float(x[3]) < 0)
	except:
		sindex = 0
	while sindex > 0:
		redtxn = t_list.pop(sindex)
		gain = 0
		i = 0
		#print("For txn -> ", redtxn)
		#for i in range(sindex):
		while i <= sindex:
			#print(t_list)
			b_units = float(t_list[i][2])
			b_amt = float(t_list[i][3])
			b_price = float(t_list[i][1])
			s_units = abs(float(redtxn[2]))
			s_amt = abs(float(redtxn[3]))
			s_price = abs(float(redtxn[1]))
			#print("GT1", redtxn, i, b_units, s_units)
			if b_units > s_units:
				#print("Gain: ", (s_price - b_price) * s_units, " Units: ", (-s_units), " Amt: ", (-s_price))
				gain =  gain + (s_price - b_price) * s_units
				t_list[i][2] = str(b_units - s_units)
				t_list[i][3] = str((b_units - s_units) * float(t_list[i][1]))
				#print("In if")
				i = i + 1
				break
			else:
				#print("In else")
				s_txn = t_list.pop(i)
				gain = gain + (s_price - b_price) * b_units
				redtxn[2] = str(b_units - s_units)
				redtxn[3] = str((b_units - s_units) * float(redtxn[1]))
				#print("GT", gain, s_price, b_price, s_units)
		#print("Gain: ", redtxn[0], gain)
		gain_list.append([redtxn[0], gain])
		try:
			sindex = next(t_list.index(x) for x in t_list if float(x[3]) < 0)
		except:
			sindex = -1
	#print(t_list)
	#print(gain_list)
	print(gain_summary(gain_list))
	#print(sindex)


if __name__ == "__main__":
	tas.reverse()
	capital_gain(tas)

